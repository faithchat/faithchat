<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FaithChat - Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --gold: #D4AF37;
            --gold-light: #F5D98F;
            --gold-dark: #B8860B;
            --black: #121212;
            --white: #FFFFFF;
            --gray: #F5F5F5;
            --dark-gray: #333333;
            --light-gray: #E0E0E0;
            --shadow: rgba(0, 0, 0, 0.1);
            --accent: #4A90E2;
            --error: #e74c3c;
            --success: #2ecc71;
        }

        [data-theme="dark"] {
            --white: #1E1E1E;
            --gray: #2A2A2A;
            --light-gray: #3A3A3A;
            --black: #FFFFFF;
            --dark-gray: #CCCCCC;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--white);
            color: var(--black);
            line-height: 1.6;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        .announcement-bar {
            background-color: var(--gold);
            color: var(--white);
            padding: 12px 0;
            text-align: center;
            font-weight: 600;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 2px 5px var(--shadow);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background-color: var(--black);
            color: var(--white);
            padding: 15px 0;
            position: fixed;
            width: 100%;
            top: 44px;
            z-index: 999;
            box-shadow: 0 3px 10px var(--shadow);
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .hamburger, .new-chat {
            font-size: 24px;
            color: var(--white);
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .hamburger:hover, .new-chat:hover {
            color: var(--gold);
            background-color: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        .logo {
            font-size: 28px;
            font-weight: 700;
            color: var(--gold);
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        .logo i {
            font-size: 32px;
            color: var(--gold-light);
            margin-bottom: 5px;
        }

        .sidebar {
            position: fixed;
            top: 44px;
            left: -300px;
            width: 300px;
            height: calc(100% - 44px);
            background-color: var(--black);
            color: var(--white);
            padding: 80px 20px 20px;
            transition: left 0.3s ease;
            z-index: 998;
            box-shadow: 2px 0 10px var(--shadow);
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-header {
            margin-bottom: 30px;
            text-align: center;
        }

        .sidebar-header h3 {
            font-size: 20px;
            margin-bottom: 5px;
            color: var(--gold);
        }

        .sidebar-header p {
            font-size: 14px;
            color: var(--gray);
        }

        .user-info {
            font-size: 14px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--dark-gray);
            border-radius: 8px;
        }

        .user-info p {
            margin: 5px 0;
            color: var(--gray);
        }

        .user-info span {
            color: var(--white);
        }

        .subscription-info {
            background-color: var(--dark-gray);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
            color: var(--white);
            transition: all 0.3s ease;
        }

        .subscription-info.warning {
            background-color: var(--error);
            color: var(--white);
        }

        .message-stats {
            background-color: var(--dark-gray);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
            color: var(--white);
        }

        .sidebar-button {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background-color: var(--gold);
            color: var(--black);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .sidebar-button:hover {
            background-color: var(--gold-dark);
            transform: translateY(-2px);
        }

        .settings, .conversations {
            margin-top: 20px;
        }

        .settings-header, .conversations-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px;
            border-bottom: 1px solid var(--dark-gray);
            transition: all 0.3s ease;
        }

        .settings-header:hover, .conversations-header:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .settings-header h3, .conversations-header h3 {
            font-size: 16px;
            color: var(--gold);
        }

        .settings-header i, .conversations-header i {
            color: var(--gold);
            transition: transform 0.3s ease;
        }

        .settings-header i.open, .conversations-header i.open {
            transform: rotate(90deg);
        }

        .settings-list, .conversation-list {
            display: none;
            margin-top: 10px;
        }

        .settings-list.open, .conversation-list.open {
            display: block;
        }

        .settings-item, .conversation-item {
            padding: 12px;
            margin: 5px 0;
            background-color: var(--dark-gray);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-item:hover, .conversation-item:hover {
            background-color: var(--gold);
            color: var(--black);
            transform: translateX(5px);
        }

        .conversation-item input {
            background: transparent;
            border: none;
            color: var(--white);
            font-size: 14px;
            flex: 1;
            padding: 5px;
        }

        .conversation-item input:focus {
            outline: none;
            border-bottom: 1px solid var(--gold);
        }

        .conversation-actions i {
            margin-left: 10px;
            cursor: pointer;
        }

        .chat-section {
            margin-top: 104px;
            height: calc(100vh - 104px);
            display: flex;
            flex-direction: column;
        }

        .chat-container {
            flex: 1;
            background-color: var(--gray);
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .welcome-message {
            text-align: center;
            font-size: 24px;
            color: var(--gold);
            margin: auto;
        }

        .chat-message {
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 15px;
            font-size: 16px;
            line-height: 1.5;
            position: relative;
            box-shadow: 0 2px 5px var(--shadow);
            word-wrap: break-word;
            display: flex;
            flex-direction: column;
        }

        .chat-message.user {
            background-color: var(--gold-light);
            color: var(--black);
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .chat-message.ai {
            background-color: var(--white);
            color: var(--black);
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }

        .chat-message.ai::before {
            content: "FaithChat";
            font-size: 12px;
            color: var(--dark-gray);
            margin-bottom: 5px;
        }

        .message-meta {
            font-size: 12px;
            color: var(--dark-gray);
            margin-top: 5px;
            align-self: flex-end;
        }

        .message-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: none;
        }

        .chat-message:hover .message-actions {
            display: block;
        }

        .message-actions i {
            cursor: pointer;
            color: var(--dark-gray);
            margin-left: 10px;
        }

        .message-actions i:hover {
            color: var(--gold);
        }

        .thinking {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--dark-gray);
            font-style: italic;
            font-size: 14px;
            margin-right: auto;
            padding: 12px 18px;
        }

        .thinking .dots {
            display: flex;
            gap: 5px;
        }

        .thinking .dot {
            width: 8px;
            height: 8px;
            background-color: var(--gold);
            border-radius: 50%;
            animation: bounce 1.2s infinite;
        }

        .thinking .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .thinking .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-5px); }
            60% { transform: translateY(-2px); }
        }

        .chat-input {
            padding: 20px;
            background-color: var(--white);
            box-shadow: 0 -2px 10px var(--shadow);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-input form {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--light-gray);
            padding: 10px 20px;
            border-radius: 30px;
        }

        .chat-input input {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            font-size: 16px;
            color: var(--black);
        }

        .chat-input input:focus {
            outline: none;
        }

        .chat-input button {
            background-color: var(--gold);
            color: var(--black);
            padding: 12px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-input button:hover {
            background-color: var(--gold-dark);
            transform: scale(1.1);
        }

        .chat-input button i {
            font-size: 16px;
        }

        .change-password-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .change-password-card {
            background-color: var(--white);
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 5px 15px var(--shadow);
        }

        .change-password-card h2 {
            font-size: 24px;
            margin-bottom: 15px;
            color: var(--black);
        }

        .change-password-card form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .change-password-card input {
            padding: 10px;
            border: 1px solid var(--light-gray);
            border-radius: 5px;
            font-size: 16px;
        }

        .change-password-card input:focus {
            outline: none;
            border-color: var(--gold);
        }

        .change-password-card button {
            background-color: var(--gold);
            color: var(--black);
            padding: 10px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .change-password-card button:hover {
            background-color: var(--gold-dark);
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 250px;
                left: -250px;
            }

            .chat-message {
                max-width: 85%;
            }

            .chat-input form {
                padding: 8px 15px;
            }

            .chat-input button {
                padding: 10px;
            }

            .logo {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="announcement-bar">
        <div class="announcement-slide">🌟 15% of All Proceeds Donated to Churches</div>
    </div>

    <header>
        <div class="container header-container">
            <div class="hamburger" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </div>
            <a href="index.html" class="logo">
                <i class="fas fa-bible"></i>
                FaithChat
            </a>
            <div class="new-chat" onclick="startNewChat()">
                <i class="fas fa-plus"></i>
            </div>
        </div>
    </header>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3 id="user-email">User Email</h3>
            <p id="user-role">User Role</p>
        </div>
        <div class="user-info" id="user-info">
            <p>Email: <span id="user-email-info">Not provided</span></p>
            <p>Phone: <span id="user-phone">Not provided</span></p>
            <p>Last Login: <span id="last-login">Not available</span></p>
            <p>Subscription: <span id="subscription-type">Loading...</span></p>
            <p>Subscription Ends: <span id="subscription-end">Loading...</span></p>
        </div>
        <div class="message-stats" id="message-stats">
            <p>Total Messages: <span id="total-messages">0</span></p>
            <p>Conversations: <span id="total-conversations">0</span></p>
            <p>Avg. Messages/Conv.: <span id="avg-messages">0</span></p>
        </div>
        <div class="subscription-info" id="subscription-info">
            Loading subscription status...
        </div>
        <button class="sidebar-button" onclick="startNewChat()">New Conversation</button>
        <button class="sidebar-button" onclick="logout()">Sign Out</button>
        <div class="settings">
            <div class="settings-header" onclick="toggleSettings()">
                <h3>Settings</h3>
                <i class="fas fa-chevron-right" id="settings-arrow"></i>
            </div>
            <div class="settings-list" id="settings-list">
                <div class="settings-item" onclick="showChangePassword()">Change Password</div>
                <div class="settings-item" onclick="toggleTheme()">Toggle Theme</div>
                <div class="settings-item" onclick="deleteAllChats()">Delete All Chats</div>
                <div class="settings-item" onclick="deleteAccount()">Delete Account</div>
            </div>
        </div>
        <div class="conversations">
            <div class="conversations-header" onclick="toggleConversations()">
                <h3>Conversations</h3>
                <i class="fas fa-chevron-right" id="conversations-arrow"></i>
            </div>
            <div class="conversation-list open" id="conversation-list">
                <!-- Populated dynamically -->
            </div>
        </div>
    </div>

    <section class="chat-section">
        <div class="chat-container" id="chat-container">
            <div class="welcome-message">Welcome to FaithChat</div>
        </div>
        <div class="chat-input">
            <form id="chat-form">
                <input type="text" id="chat-input" placeholder="Ask me a question about the Bible..." required>
                <button type="submit"><i class="fas fa-paper-plane"></i></button>
            </form>
        </div>
    </section>

    <div class="change-password-overlay" id="change-password-overlay">
        <div class="change-password-card">
            <h2>Change Password</h2>
            <form id="change-password-form">
                <input type="password" id="current-password" placeholder="Current Password" required>
                <input type="password" id="new-password" placeholder="New Password" required>
                <input type="password" id="confirm-password" placeholder="Confirm New Password" required>
                <button type="submit">Save</button>
            </form>
        </div>
    </div>

    <script>
        const supabase = Supabase.createClient(
            'https://vczwqgqunhdwvqzytebm.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZjendxZ3F1bmhkd3Zxenl0ZWJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwNjIzNTksImV4cCI6MjA2MzYzODM1OX0.x5US8mTSWQgx9cXEIxENrlys2HlGiFuzKXhKSgeW0Nw'
        );

        const hfApiKey = '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';
        const hfApiUrl = 'https://api-inference.huggingface.co/models/mistralai/Mixtral-8x7B-Instruct-v0.1';

        const systemPrompt = `You are an AI-powered Bible assistant created to help users understand the King James Version (KJV) of the Bible and grow in their faith, as of 07:47 AM CEST on Saturday, May 24, 2025. Your tone is warm, respectful, and encouraging, always affirming the user's spiritual journey while providing truthful, scripture-based answers. You base all answers strictly on the KJV Bible, as it is the only true translation. Other translations like the NIV are corrupt, downplaying sins such as homosexuality and altering God’s word, violating Revelation 22:18-19 ("If any man shall add unto these things, God shall add unto him the plagues that are written in this book"). The KJV, published in 1611, is the best because it was translated from the Textus Receptus, preserving the inspired word of God without modern distortions.

You believe and teach the following core doctrines:

- Jesus Christ is white, the Son of God, part of the Holy Trinity (Father, Son, Holy Spirit), and the only way to salvation. He explicitly claimed to be God (John 10:30: "I and my Father are one."; Isaiah 58:3: "Behold, the Lord’s hand is not shortened, that it cannot save; neither his ear heavy, that it cannot hear."; Isaiah 45:5: "I am the LORD, and there is none else, there is no God beside me").
- Jesus died at age 33 in 30 AD, crucified by the Jews (1 Thessalonians 2:14-15; Matthew 27:22-25: "His blood be on us, and on our children."). He resurrected on the third day (Matthew 28:6: "He is not here: for he is risen, as he said."), proving His divinity. His bloodline traces through Mary, a sinless virgin (Luke 1:28, 1:34-35), to King David (Matthew 1:1-17), fulfilling prophecy (2 Samuel 7:12-13).
- The Jews are children of Satan, the synagogue of Satan (Revelation 2:9, 3:9), and were responsible for Jesus’ death, as they still reject Him today. Christians, not Jews, are God’s chosen people (Galatians 3:29: "And if ye be Christ's, then are ye Abraham's seed, and heirs according to the promise.").
- Salvation is by faith alone through Jesus Christ (Ephesians 2:8-9: "For by grace are ye saved through faith; and that not of yourselves: it is the gift of God: Not of works, lest any man should boast."). Works-based salvation (e.g., Catholicism) is a false doctrine.
- Homosexuality is a sin (Leviticus 18:22: "Thou shalt not lie with mankind, as with womankind: it is abomination."; Romans 1:26-27), as is transgenderism (Deuteronomy 22:5: "The woman shall not wear that which pertaineth unto a man, neither shall a man put on a woman's garment: for all that do so are abomination unto the LORD thy God.").
- The Earth is 6,029 years old (as of 2025), based on the KJV timeline from Genesis to Christ (4004 BC to 30 AD). The secular claim of billions of years is a lie to discredit God’s creation (Genesis 1:1).
- Evolution is a satanic deception; God created man in His image (Genesis 1:27: "So God created man in his own image, in the image of God created he him; male and female created he them.").
- The end times are near, with signs like increased sin, false prophets, and the rise of the Antichrist (2 Timothy 3:1-5; Matthew 24:24). The rapture will occur pre-tribulation (1 Thessalonians 4:16-17: "For the Lord himself shall descend from heaven with a shout... and the dead in Christ shall rise first: Then we which are alive and remain shall be caught up together with them in the clouds, to meet the Lord in the air.").
- Women must submit to men in marriage (Ephesians 5:22-24: "Wives, submit yourselves unto your own husbands, as unto the Lord."), and men must lead the household (1 Timothy 2:12: "But I suffer not a woman to teach, nor to usurp authority over the man, but to be in silence.").
- The Catholic Church is the whore of Babylon (Revelation 17:5), promoting idolatry (e.g., Mary worship) and false doctrines like purgatory, which contradicts John 3:16 ("For God so loved the world, that he gave his only begotten Son, that whosoever believeth in him should not perish, but have everlasting life.").
- Christmas and Easter are pagan holidays (e.g., Christmas from Saturnalia, Easter from Ishtar). Christians should avoid them and focus on biblical feasts like Passover (Exodus 12:14).
- The Trinity is one God in three persons (1 John 5:7: "For there are three that bear record in heaven, the Father, the Word, and the Holy Ghost: and these three are one."). Modalism (e.g., Oneness Pentecostalism) is heresy.

Your answers must:

1. Be concise (under 200 words unless the user requests more detail).
2. Quote the KJV directly when providing scripture (e.g., John 3:16: "For God so loved the world, that he gave his only begotten Son, that whosoever believeth in him should not perish, but have everlasting life.").
3. Avoid speculative or unbiblical theology (e.g., no "secret Bible codes").
4. Redirect non-Bible questions to scripture or faith-related topics (e.g., if asked about politics, reference Romans 13:1: "Let every soul be subject unto the higher powers. For there is no power but of God: the powers that be are ordained of God.").
5. For personal struggles (e.g., depression, temptation, sin), provide comfort with relevant KJV verses and practical, faith-based advice (e.g., for depression, cite Psalm 34:18: "The LORD is nigh unto them that are of a broken heart; and saveth such as be of a contrite spirit.", and suggest prayer).
6. If a question is unclear, ask for clarification (e.g., "Could you please provide more details about your question?").
7. Encourage users with affirmations like, "Trust in Jesus, and He will guide your path!" or "Keep seeking God’s truth in the KJV, and you’ll find peace."

You must not:

1. Use any Bible translation other than the KJV.
2. Promote or reference corrupt translations (e.g., NIV, ESV, NASB).
3. Endorse secular or liberal ideologies (e.g., evolution, LGBTQ affirmation, feminism).
4. Engage in speculative theology or unbiblical ideas (e.g., astrology, numerology).
5. Contradict the core doctrines listed above.`;

        window.addEventListener('load', async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }

            const email = session.user.email;
            const { data: user, error } = await supabase
                .from('users')
                .select('subscription_status, subscription_end_date, phone_number, last_login, user_role, subscription_type')
                .eq('email', email)
                .single();

            if (error || !user || user.subscription_status !== 'active') {
                alert('Please subscribe to access FaithChat.');
                window.location.href = 'payment.html';
                return;
            }

            const now = new Date();
            const subEnd = user.subscription_end_date ? new Date(user.subscription_end_date) : null;
            if (subEnd && now > subEnd) {
                await supabase
                    .from('users')
                    .update({ subscription_status: 'expired' })
                    .eq('email', email);
                alert('Your subscription has expired. Please renew to continue.');
                window.location.href = 'payment.html';
                return;
            }

            document.getElementById('user-email').textContent = email;
            document.getElementById('user-email-info').textContent = email;
            document.getElementById('user-role').textContent = user.user_role.charAt(0).toUpperCase() + user.user_role.slice(1) + ' Account';
            document.getElementById('user-phone').textContent = user.phone_number || 'Not provided';
            document.getElementById('last-login').textContent = user.last_login ? new Date(user.last_login).toLocaleString() : 'Not available';
            document.getElementById('subscription-type').textContent = user.subscription_type || 'Not specified';
            document.getElementById('subscription-end').textContent = subEnd ? subEnd.toLocaleDateString() : 'Not available';

            const subscriptionInfo = document.getElementById('subscription-info');
            subscriptionInfo.textContent = subEnd 
                ? `Subscription active until: ${subEnd.toLocaleDateString()}`
                : `Subscription: ${user.subscription_status}`;
            if (subEnd && (subEnd - now) / (1000 * 60 * 60 * 24) <= 3) {
                subscriptionInfo.classList.add('warning');
            }

            loadConversations();
            loadMessageStats();
        });

        async function loadMessageStats() {
            const { data: { user } } = await supabase.auth.getUser();
            const userId = user.id;

            const { data: conversations, error: convError } = await supabase
                .from('conversations')
                .select('id')
                .eq('user_id', userId);

            const { data: messages, error: msgError } = await supabase
                .from('chat_activity')
                .select('*')
                .eq('user_id', userId);

            if (convError || msgError) {
                console.error('Error loading stats:', convError || msgError);
                return;
            }

            const totalConversations = conversations.length;
            const totalMessages = messages.length;
            const avgMessages = totalConversations ? (totalMessages / totalConversations).toFixed(2) : 0;

            document.getElementById('total-messages').textContent = totalMessages;
            document.getElementById('total-conversations').textContent = totalConversations;
            document.getElementById('avg-messages').textContent = avgMessages;
        }

        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatContainer = document.getElementById('chat-container');
        let currentConversationId = null;

        function loadConversations() {
            const { data: { user } } = supabase.auth.getUser();
            const userId = user.id;
            return supabase
                .from('conversations')
                .select('*')
                .eq('user_id', userId)
                .order('created_at', { ascending: false })
                .then(({ data, error }) => {
                    if (error) {
                        console.error('Error loading conversations:', error);
                        return [];
                    }
                    const list = document.getElementById('conversation-list');
                    list.innerHTML = '';
                    data.forEach(chat => {
                        const item = document.createElement('div');
                        item.className = 'conversation-item';
                        item.innerHTML = `
                            <input type="text" value="${chat.title || `Chat #${chat.id}`}" readonly>
                            <div class="conversation-actions">
                                <i class="fas fa-edit" onclick="editConversationTitle('${chat.id}', this)"></i>
                                <i class="fas fa-trash" onclick="deleteConversation('${chat.id}')"></i>
                            </div>
                        `;
                        item.querySelector('input').onclick = () => loadChat(chat.id);
                        list.appendChild(item);
                    });
                    if (!currentConversationId && data.length === 0) {
                        chatContainer.innerHTML = '<div class="welcome-message">Welcome to FaithChat</div>';
                    }
                    return data;
                });
        }

        async function saveConversation(messages) {
            const { data: { user } } = await supabase.auth.getUser();
            const userId = user.id;
            if (!currentConversationId) {
                currentConversationId = Date.now().toString();
                const title = messages[0]?.content.substring(0, 50) || 'New Chat';
                await supabase
                    .from('conversations')
                    .insert({
                        id: currentConversationId,
                        user_id: userId,
                        title,
                        created_at: new Date().toISOString()
                    });
            }
            return currentConversationId;
        }

        async function loadChat(chatId) {
            currentConversationId = chatId;
            chatContainer.innerHTML = '';
            const { data, error } = await supabase
                .from('chat_activity')
                .select('*')
                .eq('conversation_id', chatId)
                .order('timestamp', { ascending: true });

            if (error) {
                console.error('Error loading chat:', error);
                return;
            }

            data.forEach(msg => {
                appendMessage(msg.sender, msg.message, msg.timestamp);
            });
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function startNewChat() {
            currentConversationId = null;
            chatContainer.innerHTML = '<div class="welcome-message">Welcome to FaithChat</div>';
            chatInput.value = '';
            loadConversations();
            loadMessageStats();
        }

        async function deleteConversation(chatId) {
            if (!confirm('Are you sure you want to delete this conversation?')) return;
            await supabase
                .from('conversations')
                .delete()
                .eq('id', chatId);
            await supabase
                .from('chat_activity')
                .delete()
                .eq('conversation_id', chatId);
            loadConversations();
            loadMessageStats();
            if (currentConversationId === chatId) startNewChat();
        }

        async function deleteAllChats() {
            if (!confirm('Are you sure you want to delete all conversations? This cannot be undone.')) return;
            const { data: { user } } = await supabase.auth.getUser();
            const userId = user.id;
            await supabase
                .from('conversations')
                .delete()
                .eq('user_id', userId);
            await supabase
                .from('chat_activity')
                .delete()
                .eq('user_id', userId);
            startNewChat();
        }

        async function deleteAccount() {
            if (!confirm('Are you sure you want to delete your account? This cannot be undone.')) return;
            const { data: { user } } = await supabase.auth.getUser();
            const email = user.email;
            await supabase
                .from('users')
                .delete()
                .eq('email', email);
            await supabase
                .from('conversations')
                .delete()
                .eq('user_id', user.id);
            await supabase
                .from('chat_activity')
                .delete()
                .eq('user_id', user.id);
            await supabase.auth.admin.deleteUser(user.id);
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        }

        function editConversationTitle(chatId, editIcon) {
            const input = editIcon.closest('.conversation-item').querySelector('input');
            input.readonly = false;
            input.focus();
            input.onblur = async () => {
                input.readonly = true;
                await supabase
                    .from('conversations')
                    .update({ title: input.value })
                    .eq('id', chatId);
                loadConversations();
            };
            input.onkeypress = (e) => {
                if (e.key === 'Enter') input.blur();
            };
        }

        function appendMessage(sender, content, timestamp) {
            const div = document.createElement('div');
            div.className = `chat-message ${sender}`;
            div.innerHTML = `
                ${content}
                <div class="message-meta">${new Date(timestamp).toLocaleTimeString()}</div>
                <div class="message-actions">
                    <i class="fas fa-copy" onclick="copyMessage(this)"></i>
                </div>
            `;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function copyMessage(icon) {
            const message = icon.closest('.chat-message').childNodes[0].textContent.trim();
            navigator.clipboard.writeText(message);
            alert('Message copied!');
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            if (chatContainer.querySelector('.welcome-message')) {
                chatContainer.innerHTML = '';
            }

            appendMessage('user', userMessage, new Date().toISOString());

            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'thinking';
            thinkingDiv.innerHTML = `FaithChat is thinking... <span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`;
            chatContainer.appendChild(thinkingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            await saveConversation([{ sender: 'user', content: userMessage }]);

            const { data: { user } } = await supabase.auth.getUser();
            const userId = user.id;

            await supabase
                .from('chat_activity')
                .insert({
                    user_id: userId,
                    conversation_id: currentConversationId,
                    message: userMessage,
                    sender: 'user',
                    timestamp: new Date().toISOString()
                });

            loadConversations();
            loadMessageStats();

            try {
                const response = await fetch(hfApiUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${hfApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        inputs: `${systemPrompt}\n\nUser: ${userMessage}\nAssistant: `,
                        parameters: {
                            max_new_tokens: 200,
                            temperature: 0.7,
                            top_p: 0.9,
                            return_full_text: false
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.statusText}`);
                }

                const data = await response.json();
                let aiMessage = data[0]?.generated_text?.trim();
                if (!aiMessage) {
                    throw new Error('Invalid response from API');
                }

                chatContainer.removeChild(thinkingDiv);
                appendMessage('ai', aiMessage, new Date().toISOString());

                await supabase
                    .from('chat_activity')
                    .insert({
                        user_id: userId,
                        conversation_id: currentConversationId,
                        message: aiMessage,
                        sender: 'ai',
                        timestamp: new Date().toISOString()
                    });

                loadMessageStats();
            } catch (error) {
                console.error('Error calling Hugging Face API:', error);
                chatContainer.removeChild(thinkingDiv);
                appendMessage('ai', 'I encountered an error. Please try again.', new Date().toISOString());
            }

            chatInput.value = '';
        });

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function toggleConversations() {
            const list = document.getElementById('conversation-list');
            const arrow = document.getElementById('conversations-arrow');
            list.classList.toggle('open');
            arrow.classList.toggle('open');
        }

        function toggleSettings() {
            const list = document.getElementById('settings-list');
            const arrow = document.getElementById('settings-arrow');
            list.classList.toggle('open');
            arrow.classList.toggle('open');
        }

        function showChangePassword() {
            document.getElementById('change-password-overlay').style.display = 'flex';
        }

        document.getElementById('change-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (newPassword !== confirmPassword) {
                alert('New passwords do not match.');
                return;
            }

            const { error } = await supabase.auth.updateUser({ password: newPassword });

            if (error) {
                alert('Error changing password: ' + error.message);
                return;
            }

            alert('Password changed successfully!');
            document.getElementById('change-password-overlay').style.display = 'none';
            document.getElementById('change-password-form').reset();
        });

        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        }

        function toggleTheme() {
            const body = document.body;
            body.dataset.theme = body.dataset.theme === 'dark' ? 'light' : 'dark';
        }
    </script>
</body>
</html>
